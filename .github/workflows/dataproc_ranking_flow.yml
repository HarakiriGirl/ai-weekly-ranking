# GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: å®Œå…¨è‡ªå‹•é€±æ¬¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”Ÿæˆ
# ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹: .github/workflows/dataproc_ranking_flow.yml

name: Weekly AI Tools Ranking (Auto)

on:
  # æ¯é€±é‡‘æ›œ 16:00 JST (07:00 UTC) ã«è‡ªå‹•å®Ÿè¡Œ
  # ãƒ‡ãƒ¼ã‚¿åé›†å®Œäº†å¾Œï¼ˆé‡‘æ›œ13:00ï¼‰ã®2æ™‚é–“å¾Œå®Ÿè¡Œ
  schedule:
    - cron: '0 7 * * 5'  
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      week:
        description: 'å¯¾è±¡é€± (YYYY-WXXå½¢å¼, ç©ºç™½ã§ä»Šé€±)'
        required: false
        type: string

# æ¨©é™è¨­å®š
permissions:
  contents: write  # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ãŸã‚

jobs:
  auto-ranking:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        pip install -r requirements.txt
        python -m unidic download
    
    - name: ğŸ” ãƒ‡ãƒ¼ã‚¿å‰å‡¦ç†å®Ÿè¡Œ
      run: |
        echo "Starting preprocessing..."
        python dataproc/scripts/preprocess.py
        echo "Preprocessing completed"
    
    - name: ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—å®Ÿè¡Œ
      run: |
        echo "Starting ranking calculation..."
        if [ -n "${{ github.event.inputs.week }}" ]; then
          python dataproc/scripts/rank.py --week "${{ github.event.inputs.week }}"
        else
          python dataproc/scripts/rank.py
        fi
        echo "Ranking calculation completed"
    
    - name: ğŸ“„ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Ÿè¡Œ
      run: |
        echo "Starting report generation..."
        if [ -n "${{ github.event.inputs.week }}" ]; then
          python dataproc/scripts/render.py --week "${{ github.event.inputs.week }}"
        else
          python dataproc/scripts/render.py
        fi
        echo "Report generation completed"
    
    - name: ğŸ’¾ çµæœã‚’ã‚³ãƒŸãƒƒãƒˆ
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
        git add dataproc/processed/ dataproc/aggregated/ dataproc/reports/
        
        if git diff --staged --quiet; then
          echo "å¤‰æ›´ãªã—ã€ã‚³ãƒŸãƒƒãƒˆã‚¹ã‚­ãƒƒãƒ—"
        else
          # é€±ç•ªå·å–å¾—ï¼ˆæ‰‹å‹•å®Ÿè¡Œæ™‚ã¯æŒ‡å®šå€¤ã€è‡ªå‹•å®Ÿè¡Œæ™‚ã¯ç¾åœ¨é€±ï¼‰
          if [ -n "${{ github.event.inputs.week }}" ]; then
            WEEK="${{ github.event.inputs.week }}"
          else
            WEEK=$(date +%G)-W$(date +%V)
          fi
          
          git commit -m "ğŸ† Auto-generated weekly ranking: ${WEEK}"
          git push
          
          echo "âœ… Weekly ranking committed: ${WEEK}"
        fi
    
    - name: ğŸ‰ å®Œäº†é€šçŸ¥
      run: |
        # é€±ç•ªå·å–å¾—
        if [ -n "${{ github.event.inputs.week }}" ]; then
          WEEK="${{ github.event.inputs.week }}"
        else
          WEEK=$(date +%G)-W$(date +%V)
        fi
        
        echo "âœ… å®Œå…¨è‡ªå‹•é€±æ¬¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”Ÿæˆå®Œäº†"
        echo "ğŸ“Š å¯¾è±¡é€±: ${WEEK}"
        echo "ğŸ“ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«:"
        echo "   - dataproc/processed/$(date +'%Y-%m-%d').parquet"
        echo "   - dataproc/aggregated/${WEEK}.parquet"
        echo "   - dataproc/reports/${WEEK}.md"
        echo ""
        echo "ğŸ”— ãƒ¬ãƒãƒ¼ãƒˆç¢ºèª: dataproc/reports/${WEEK}.md"
    
    - name: ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±
      if: failure()
      run: |
        echo "âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
        echo "ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ :"
        ls -la dataproc/
        echo "ğŸ“‚ processed:"
        ls -la dataproc/processed/ || echo "processed directory not found"
        echo "ğŸ“‚ aggregated:"
        ls -la dataproc/aggregated/ || echo "aggregated directory not found"
        echo "ğŸ“‚ reports:"
        ls -la dataproc/reports/ || echo "reports directory not found"
